<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings ‚Äî Papermint</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="theme.js"></script>
</head>
<body>
  <div class="dashboard">

    <!-- ===== TOP BAR ===== -->
    <header class="dashboard-topbar">
      <div class="topbar-left">
        <a href="index.html" class="topbar-logo" style="text-decoration:none">‚óÜ papermint</a>
      </div>
      <div class="topbar-right">
        <a href="dashboard.html" class="btn btn-ghost">‚Üê Dashboard</a>
        <div class="avatar-dropdown">
          <button type="button" class="avatar avatar-btn" id="avatar" onclick="toggleAvatarMenu()" title="Account">?</button>
          <div class="avatar-menu" id="avatar-menu">
            <a href="settings.html" class="avatar-menu-item">‚öô Preferences</a>
            <button type="button" class="avatar-menu-item" onclick="handleLogoutSettings()">Log out</button>
          </div>
        </div>
      </div>
    </header>

    <!-- ===== SIDEBAR ===== -->
    <aside class="dashboard-sidebar">
      <div class="sidebar-item" onclick="window.location='dashboard.html'">
        <span class="icon">‚Üê</span> Back to dashboard
      </div>
      <div class="sidebar-spacer"></div>
      <div class="sidebar-label">Settings</div>
      <div class="sidebar-item active">
        <span class="icon">‚öô</span> Preferences
      </div>
    </aside>

    <!-- ===== MAIN ===== -->
    <main class="dashboard-main" id="main-content">
      <div class="greeting">
        <h1>Settings</h1>
        <p>Configure API keys, pipeline parameters, and search preferences.</p>
      </div>

      <div id="settings-status" style="display:none" class="loading-indicator"></div>

      <div class="settings-grid">

        <!-- Profile -->
        <div class="settings-card" style="grid-column: 1 / -1">
          <h3>Profile</h3>
          <p class="settings-desc">Tell us about yourself ‚Äî this context is shared with the AI agents to tailor their analysis to your perspective.</p>

          <div class="form-group">
            <label>Role</label>
            <div class="role-options" id="settings-role-options">
              <button type="button" class="role-chip" data-role="Researcher" onclick="pickSettingsRole(this)">üî¨ Researcher</button>
              <button type="button" class="role-chip" data-role="VC / Investor" onclick="pickSettingsRole(this)">üí∞ VC / Investor</button>
              <button type="button" class="role-chip" data-role="Founder" onclick="pickSettingsRole(this)">üöÄ Founder</button>
              <button type="button" class="role-chip" data-role="Engineer" onclick="pickSettingsRole(this)">‚öôÔ∏è Engineer</button>
              <button type="button" class="role-chip" data-role="Student" onclick="pickSettingsRole(this)">üéì Student</button>
              <button type="button" class="role-chip" data-role="Other" onclick="pickSettingsRole(this)">‚ú¶ Other</button>
            </div>
            <input id="settings-custom-role" type="text" placeholder="Your role‚Ä¶"
              style="display:none; margin-top:8px" />
          </div>

          <div class="form-group">
            <label for="settings-bio">How do you use Papermint?</label>
            <textarea id="settings-bio" rows="3"
              placeholder="e.g. I'm scouting for breakthroughs in biotech to inform our fund's thesis‚Ä¶"
              style="width:100%; padding:10px 14px; background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-sm); font-size:0.9rem; font-family:inherit; resize:vertical;"></textarea>
          </div>
        </div>

        <!-- API Keys -->
        <div class="settings-card">
          <h3>API Keys</h3>
          <p class="settings-desc">Your keys are stored in the running server's memory only.</p>

          <div class="form-group">
            <label for="anthropic-key">Anthropic API Key</label>
            <div class="key-input-row">
              <input id="anthropic-key" type="password" placeholder="sk-ant-‚Ä¶" autocomplete="off" />
              <span id="anthropic-status" class="key-status"></span>
            </div>
          </div>

          <div class="form-group">
            <label for="browserbase-key">Browserbase API Key</label>
            <div class="key-input-row">
              <input id="browserbase-key" type="password" placeholder="bb_live_‚Ä¶" autocomplete="off" />
              <span id="browserbase-status" class="key-status"></span>
            </div>
          </div>

          <div class="form-group">
            <label for="browserbase-project">Browserbase Project ID</label>
            <input id="browserbase-project" type="text" placeholder="project_‚Ä¶" autocomplete="off" />
          </div>
        </div>

        <!-- Appearance -->
        <div class="settings-card">
          <h3>Appearance</h3>
          <p class="settings-desc">Switch between light and dark mode.</p>
          <div class="form-group">
            <div class="toggle-row">
              <div>
                <strong>Dark mode</strong>
                <span class="settings-sub">Use dark colors across the site</span>
              </div>
              <label class="toggle">
                <input id="dark-mode-toggle" type="checkbox" onchange="toggleDarkMode(this.checked)" />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- Pipeline Parameters -->
        <div class="settings-card">
          <h3>Pipeline</h3>
          <p class="settings-desc">Controls how many papers are fetched and how many debate rounds to run.</p>

          <div class="form-group">
            <label for="candidate-count">Papers per source</label>
            <div class="range-row">
              <input id="candidate-count" type="range" min="1" max="20" value="5" />
              <span id="candidate-count-val" class="range-val">5</span>
            </div>
          </div>

          <div class="form-group">
            <label for="top-k">Papers kept after filtering</label>
            <div class="range-row">
              <input id="top-k" type="range" min="1" max="20" value="5" />
              <span id="top-k-val" class="range-val">5</span>
            </div>
          </div>

          <div class="form-group">
            <label for="debate-rounds">Debate rounds</label>
            <div class="range-row">
              <input id="debate-rounds" type="range" min="1" max="5" value="2" />
              <span id="debate-rounds-val" class="range-val">2</span>
            </div>
          </div>

        </div>

        <!-- Poke Integration -->
        <div class="settings-card">
          <h3>Poke Integration</h3>
          <p class="settings-desc">Link your Papermint account to the Poke group-chat bot. Generate a token, then paste it into the chat.</p>

          <div class="form-group">
            <label>Link Token</label>
            <div class="key-input-row">
              <input id="link-token-display" type="text" readonly
                placeholder="Click generate to create a token"
                style="font-family: monospace; letter-spacing: 0.5px;" />
              <button class="btn btn-ghost" id="copy-token-btn" onclick="copyLinkToken()" style="display:none" title="Copy to clipboard">üìã</button>
            </div>
            <button class="btn btn-outline" onclick="generateLinkToken()" id="gen-token-btn" style="margin-top: 8px;">
              Generate link token
            </button>
            <p id="token-expiry" style="margin-top: 6px; font-size: 0.8rem; color: var(--text-secondary); display: none;"></p>
          </div>
        </div>

        <!-- Source toggles -->
        <div class="settings-card">
          <h3>Sources</h3>
          <p class="settings-desc">Choose which sources to search and scrape. Disabled sources are skipped by the pipeline.</p>

          <div class="toggle-row">
            <div>
              <strong>arXiv</strong>
              <span class="settings-sub">Preprint server (API, no key required)</span>
            </div>
            <label class="toggle">
              <input id="source-arxiv" type="checkbox" />
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="toggle-row">
            <div>
              <strong>bioRxiv</strong>
              <span class="settings-sub">Biology preprints (via Browserbase)</span>
            </div>
            <label class="toggle">
              <input id="source-biorxiv" type="checkbox" />
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="toggle-row">
            <div>
              <strong>OpenAlex</strong>
              <span class="settings-sub">Open catalog of scholarly works (API)</span>
            </div>
            <label class="toggle">
              <input id="source-openalex" type="checkbox" />
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="toggle-row">
            <div>
              <strong>Semantic Scholar</strong>
              <span class="settings-sub">AI-backed search (API, optional key)</span>
            </div>
            <label class="toggle">
              <input id="source-semantic_scholar" type="checkbox" />
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="toggle-row">
            <div>
              <strong>Internet search</strong>
              <span class="settings-sub">Google / Google Scholar (via Browserbase)</span>
            </div>
            <label class="toggle">
              <input id="source-internet" type="checkbox" />
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
      </div>

      <div style="margin-top: 24px">
        <button class="btn btn-primary" onclick="saveSettings()" id="save-btn">Save settings</button>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script>
    let _settingsUserId = null;
    let _settingsRole = '';

    function toggleAvatarMenu() {
      document.getElementById('avatar-menu').classList.toggle('open');
    }
    document.addEventListener('click', function(e) {
      const d = document.querySelector('.avatar-dropdown');
      if (d && !d.contains(e.target)) document.getElementById('avatar-menu').classList.remove('open');
    });
    async function handleLogoutSettings() {
      await authSignOut();
      window.location.href = 'index.html';
    }

    // --- Init ---
    (async () => {
      const user = await requireAuth();
      if (!user) return;
      _settingsUserId = user.id;

      const { data: profile } = await getProfile(user.id);
      const name = profile?.first_name || user.email?.split('@')[0] || '?';
      document.getElementById('avatar').textContent = name.charAt(0).toUpperCase();

      await loadSettings();
      await loadProfile();
    })();

    // Bind range inputs to display values
    ['candidate-count', 'top-k', 'debate-rounds'].forEach(id => {
      const input = document.getElementById(id);
      const display = document.getElementById(id + '-val');
      input.addEventListener('input', () => { display.textContent = input.value; });
    });

    // --- Profile role picker ---
    function pickSettingsRole(btn) {
      document.querySelectorAll('#settings-role-options .role-chip').forEach(c => c.classList.remove('selected'));
      btn.classList.add('selected');
      _settingsRole = btn.dataset.role;

      const custom = document.getElementById('settings-custom-role');
      if (_settingsRole === 'Other') {
        custom.style.display = 'block';
        custom.focus();
      } else {
        custom.style.display = 'none';
        custom.value = '';
      }
    }

    async function loadProfile() {
      if (!_settingsUserId) return;
      try {
        const p = await fetchProfileAPI(_settingsUserId);
        const role = p.role || '';
        const bio = p.bio || '';
        document.getElementById('settings-bio').value = bio;

        // Select the matching role chip
        const chips = document.querySelectorAll('#settings-role-options .role-chip');
        const builtInRoles = ['Researcher', 'VC / Investor', 'Founder', 'Engineer', 'Student', 'Other'];
        const matchChip = Array.from(chips).find(c => c.dataset.role === role);

        if (matchChip) {
          pickSettingsRole(matchChip);
        } else if (role) {
          // Custom role: select "Other" and fill in the custom field
          const otherChip = Array.from(chips).find(c => c.dataset.role === 'Other');
          if (otherChip) {
            pickSettingsRole(otherChip);
            document.getElementById('settings-custom-role').value = role;
          }
        }
      } catch (err) {
        console.warn('Could not load profile:', err);
      }
    }

    async function loadSettings() {
      try {
        const resp = await fetch(`${API_BASE}/api/settings`);
        if (!resp.ok) throw new Error('Failed to load settings');
        const s = await resp.json();

        setRange('candidate-count', s.candidate_count || 5);
        setRange('top-k', s.top_k || 5);
        setRange('debate-rounds', s.debate_rounds || 2);
        const sources = s.sources || ['arxiv', 'biorxiv', 'openalex', 'semantic_scholar', 'internet'];
        const sourceIds = ['arxiv', 'biorxiv', 'openalex', 'semantic_scholar', 'internet'];
        sourceIds.forEach(name => {
          const el = document.getElementById('source-' + name);
          if (el) el.checked = sources.includes(name);
        });

        document.getElementById('anthropic-status').textContent = s.has_anthropic_key ? '‚úì set' : '‚úó not set';
        document.getElementById('anthropic-status').className = 'key-status ' + (s.has_anthropic_key ? 'set' : 'unset');
        document.getElementById('browserbase-status').textContent = s.has_browserbase_key ? '‚úì set' : '‚úó not set';
        document.getElementById('browserbase-status').className = 'key-status ' + (s.has_browserbase_key ? 'set' : 'unset');

        const darkEl = document.getElementById('dark-mode-toggle');
        if (darkEl) darkEl.checked = localStorage.getItem('papermint-dark-mode') === '1';
      } catch (err) {
        showStatus('‚ö† Could not load settings. Is the API server running?', true);
      }
    }

    function setRange(id, val) {
      const input = document.getElementById(id);
      input.value = val;
      document.getElementById(id + '-val').textContent = val;
    }

    async function saveSettings() {
      const btn = document.getElementById('save-btn');
      btn.textContent = 'Saving‚Ä¶';
      btn.disabled = true;

      const sourceIds = ['arxiv', 'biorxiv', 'openalex', 'semantic_scholar', 'internet'];
      const sources = sourceIds.filter(name => document.getElementById('source-' + name)?.checked);
      const body = {
        candidate_count: parseInt(document.getElementById('candidate-count').value),
        top_k: parseInt(document.getElementById('top-k').value),
        debate_rounds: parseInt(document.getElementById('debate-rounds').value),
        sources: sources.length ? sources : sourceIds,
      };

      // Only send keys if user typed something
      const antKey = document.getElementById('anthropic-key').value.trim();
      if (antKey) body.anthropic_api_key = antKey;

      const bbKey = document.getElementById('browserbase-key').value.trim();
      if (bbKey) body.browserbase_api_key = bbKey;

      const bbProj = document.getElementById('browserbase-project').value.trim();
      if (bbProj) body.browserbase_project_id = bbProj;

      try {
        // Save pipeline settings
        const resp = await fetch(`${API_BASE}/api/settings`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        if (!resp.ok) throw new Error('Save failed');

        // Save profile (role + bio)
        if (_settingsUserId) {
          let role = _settingsRole;
          if (role === 'Other') {
            const custom = document.getElementById('settings-custom-role').value.trim();
            role = custom || 'Other';
          }
          const bio = document.getElementById('settings-bio').value.trim();
          await updateProfileAPI(_settingsUserId, { role, bio });
        }

        showStatus('‚úì Settings saved', false);
        await loadSettings(); // refresh status badges
      } catch (err) {
        showStatus('‚ö† Failed to save settings: ' + err.message, true);
      }

      btn.textContent = 'Save settings';
      btn.disabled = false;
    }

    function toggleDarkMode(checked) {
      if (typeof applyTheme === 'function') applyTheme(checked);
    }

    // --- Poke link token ---
    async function generateLinkToken() {
      if (!_settingsUserId) {
        showStatus('‚ö† Not logged in.', true);
        return;
      }

      const btn = document.getElementById('gen-token-btn');
      btn.textContent = 'Generating‚Ä¶';
      btn.disabled = true;

      try {
        const resp = await fetch(`${API_BASE}/api/link-token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: _settingsUserId }),
        });
        if (!resp.ok) throw new Error('Failed to generate token');
        const data = await resp.json();

        const display = document.getElementById('link-token-display');
        display.value = data.token;
        document.getElementById('copy-token-btn').style.display = 'inline-flex';

        const exp = new Date(data.expires);
        document.getElementById('token-expiry').style.display = 'block';
        document.getElementById('token-expiry').textContent =
          `‚è± Expires at ${exp.toLocaleTimeString()} (single-use)`;

        showStatus('‚úì Token generated ‚Äî paste it in your Poke group chat.', false);
      } catch (err) {
        showStatus('‚ö† ' + err.message, true);
      }

      btn.textContent = 'Generate link token';
      btn.disabled = false;
    }

    function copyLinkToken() {
      const display = document.getElementById('link-token-display');
      navigator.clipboard.writeText(display.value).then(() => {
        showStatus('‚úì Token copied to clipboard', false);
      }).catch(() => {
        display.select();
        document.execCommand('copy');
        showStatus('‚úì Token copied', false);
      });
    }

    function showStatus(msg, isError) {
      const el = document.getElementById('settings-status');
      el.style.display = 'flex';
      el.style.borderColor = isError ? 'var(--red)' : 'var(--green)';
      el.style.color = isError ? 'var(--red)' : 'var(--green)';
      el.innerHTML = `<span>${msg}</span>`;
      setTimeout(() => { el.style.display = 'none'; }, 4000);
    }
  </script>
</body>
</html>

