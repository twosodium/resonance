<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ideas — Papermint</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="theme.js"></script>
</head>
<body>
  <div class="dashboard">

    <!-- ===== TOP BAR ===== -->
    <header class="dashboard-topbar">
      <div class="topbar-left">
        <a href="index.html" class="topbar-logo" style="text-decoration:none">◆ papermint</a>
      </div>
      <div class="topbar-right">
        <a href="dashboard.html" class="btn btn-ghost">← Dashboard</a>
        <div class="avatar-dropdown">
          <button type="button" class="avatar avatar-btn" id="avatar" onclick="toggleAvatarMenu()" title="Account">?</button>
          <div class="avatar-menu" id="avatar-menu">
            <a href="settings.html" class="avatar-menu-item">⚙ Preferences</a>
            <button type="button" class="avatar-menu-item" onclick="handleLogout()">Log out</button>
          </div>
        </div>
      </div>
    </header>

    <!-- ===== SIDEBAR ===== -->
    <aside class="dashboard-sidebar">
      <div class="sidebar-item" onclick="window.location='dashboard.html'">
        <span class="icon">←</span> Dashboard
      </div>
      <div class="sidebar-spacer"></div>
      <div class="sidebar-label">Explore</div>
      <div class="sidebar-item active">
        <span class="icon">✦</span> Top Ideas
      </div>
    </aside>

    <!-- ===== MAIN ===== -->
    <main class="dashboard-main" id="main-content">
      <div class="greeting">
        <h1>Top Ideas</h1>
        <p>The most promising research ideas found across all your past searches.</p>
      </div>

      <div class="ideas-container" id="ideas-container">
        <!-- Blobs injected by JS -->
        <div id="ideas-loading" class="loading-indicator" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)">
          <div class="loading-spinner"></div>
          <span>Loading ideas…</span>
        </div>
      </div>

      <!-- Tooltip (follows mouse) -->
      <div class="idea-tooltip" id="idea-tooltip">
        <h4 id="tooltip-title"></h4>
        <p id="tooltip-body"></p>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script>
    let allIdeas = [];

    function toggleAvatarMenu() {
      document.getElementById('avatar-menu').classList.toggle('open');
    }
    document.addEventListener('click', function(e) {
      const d = document.querySelector('.avatar-dropdown');
      if (d && !d.contains(e.target)) document.getElementById('avatar-menu').classList.remove('open');
    });
    async function handleLogout() {
      await authSignOut();
      window.location.href = 'index.html';
    }

    (async () => {
      const user = await requireAuth();
      if (!user) return;

      const { data: profile } = await getProfile(user.id);
      const name = profile?.first_name || user.email?.split('@')[0] || '?';
      document.getElementById('avatar').textContent = name.charAt(0).toUpperCase();

      await loadIdeas();
    })();

    async function loadIdeas() {
      const user = await getUser();
      if (!user) return;

      // Fetch all debates with joined paper data for this user, sorted by confidence
      let query = sb.from('debates')
        .select('*, papers(*)')
        .order('confidence', { ascending: false });
      query = query.eq('user_id', user.id);

      const { data, error } = await query;
      if (error) {
        console.error('loadIdeas:', error);
        return;
      }

      // Filter to PROMISING and INTERESTING only
      allIdeas = (data || []).filter(d =>
        d.verdict === 'PROMISING' || d.verdict === 'INTERESTING'
      );

      document.getElementById('ideas-loading').style.display = 'none';

      if (allIdeas.length === 0) {
        const container = document.getElementById('ideas-container');
        container.innerHTML = `
          <div style="text-align:center; padding:80px 24px; color:var(--text-tertiary);">
            <p style="font-size:1.1rem; margin-bottom:8px;">No promising ideas yet</p>
            <p>Run some searches from the <a href="dashboard.html" style="text-decoration:underline">dashboard</a> to see results here.</p>
          </div>`;
        return;
      }

      const ideasForApi = allIdeas.map(d => ({
        id: String(d.id),
        paper_name: (d.papers && d.papers.paper_name) || d.topic,
        topic: d.topic,
        one_liner: d.one_liner
      }));
      let edges = [];
      try {
        const res = await fetchMindmapEdges(ideasForApi);
        edges = res.edges || [];
      } catch (e) {
        console.warn('Mindmap edges failed:', e);
      }
      renderMindmap(edges);
    }

    let nodePositions = {};
    let mindmapEdges = [];
    let dragNode = null;
    let dragOffset = { x: 0, y: 0 };

    function renderMindmap(edges) {
      mindmapEdges = edges;
      const container = document.getElementById('ideas-container');
      container.innerHTML = '';
      const W = container.offsetWidth || 900;
      const H = Math.max(container.offsetHeight || 500, 400);
      const centerX = W / 2;
      const centerY = H / 2;
      const radius = Math.min(W, H) * 0.38;
      const N = allIdeas.length;

      const nodeSize = 56;

      allIdeas.forEach((idea, i) => {
        const id = String(idea.id);
        const angle = (2 * Math.PI * i) / N - Math.PI / 2;
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        nodePositions[id] = { x, y };
      });

      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('class', 'mindmap-svg');
      svg.setAttribute('width', '100%');
      svg.setAttribute('height', '100%');
      svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
      container.appendChild(svg);

      function redrawEdges() {
        const g = svg.querySelector('g.edges');
        if (!g) return;
        g.innerHTML = '';
        mindmapEdges.forEach(e => {
          const from = nodePositions[String(e.from_id)];
          const to = nodePositions[String(e.to_id)];
          if (!from || !to) return;
          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('x1', from.x);
          line.setAttribute('y1', from.y);
          line.setAttribute('x2', to.x);
          line.setAttribute('y2', to.y);
          line.setAttribute('class', 'mindmap-edge');
          g.appendChild(line);
          const midX = (from.x + to.x) / 2;
          const midY = (from.y + to.y) / 2;
          const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          label.setAttribute('x', midX);
          label.setAttribute('y', midY);
          label.setAttribute('text-anchor', 'middle');
          label.setAttribute('class', 'mindmap-edge-label');
          label.textContent = (e.label || 'related').slice(0, 20);
          g.appendChild(label);
        });
      }

      const gEdges = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      gEdges.setAttribute('class', 'edges');
      svg.appendChild(gEdges);
      redrawEdges();

      allIdeas.forEach((idea, i) => {
        const paper = idea.papers || {};
        const id = String(idea.id);
        const conf = idea.confidence || 0;
        const verdict = (idea.verdict || 'uncertain').toLowerCase();
        const pos = nodePositions[id];
        const nodeEl = document.createElement('div');
        nodeEl.className = `idea-node idea-blob ${verdict}`;
        nodeEl.dataset.id = id;
        nodeEl.style.width = nodeSize + 'px';
        nodeEl.style.height = nodeSize + 'px';
        nodeEl.style.left = (pos.x - nodeSize / 2) + 'px';
        nodeEl.style.top = (pos.y - nodeSize / 2) + 'px';
        const title = paper.paper_name || idea.topic || 'Unknown';
        const shortTitle = title.length > 24 ? title.slice(0, 21) + '…' : title;
        nodeEl.innerHTML = `<span class="blob-title">${shortTitle}</span><span class="blob-verdict">${Math.round(conf * 100)}%</span>`;

        nodeEl.addEventListener('mouseenter', e => showTooltip(e, idea));
        nodeEl.addEventListener('mousemove', moveTooltip);
        nodeEl.addEventListener('mouseleave', hideTooltip);
        nodeEl.addEventListener('click', (e) => { if (!dragNode) window.location = `dashboard.html#topic=${encodeURIComponent(idea.topic || '')}`; });

        nodeEl.addEventListener('mousedown', (e) => {
          e.preventDefault();
          dragNode = id;
          const rect = container.getBoundingClientRect();
          dragOffset.x = (e.clientX - rect.left) - pos.x;
          dragOffset.y = (e.clientY - rect.top) - pos.y;
        });

        container.appendChild(nodeEl);
      });

      const onMove = (e) => {
        if (!dragNode) return;
        const rect = container.getBoundingClientRect();
        const x = (e.clientX - rect.left) - dragOffset.x;
        const y = (e.clientY - rect.top) - dragOffset.y;
        nodePositions[dragNode].x = x;
        nodePositions[dragNode].y = y;
        const el = container.querySelector(`[data-id="${dragNode}"]`);
        if (el) {
          el.style.left = (x - nodeSize / 2) + 'px';
          el.style.top = (y - nodeSize / 2) + 'px';
        }
        redrawEdges();
      };
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', () => { dragNode = null; });
    }

    function showTooltip(e, idea) {
      const paper = idea.papers || {};
      const tooltip = document.getElementById('idea-tooltip');
      document.getElementById('tooltip-title').textContent =
        paper.paper_name || idea.topic || 'Unknown';

      const lines = [];
      if (idea.one_liner) lines.push(idea.one_liner);
      if (idea.topic) lines.push(`Topic: ${idea.topic}`);
      lines.push(`Verdict: ${idea.verdict} · ${Math.round((idea.confidence||0)*100)}% confidence`);
      if (idea.topicality != null) lines.push(`Topicality: ${Math.round(idea.topicality*100)}%`);
      document.getElementById('tooltip-body').textContent = lines.join('\n');

      tooltip.classList.add('visible');
      moveTooltip(e);
    }

    function moveTooltip(e) {
      const tooltip = document.getElementById('idea-tooltip');
      tooltip.style.left = (e.clientX + 16) + 'px';
      tooltip.style.top = (e.clientY + 16) + 'px';
    }

    function hideTooltip() {
      document.getElementById('idea-tooltip').classList.remove('visible');
    }

    window.addEventListener('resize', () => {
      if (allIdeas.length > 0 && mindmapEdges.length >= 0) renderMindmap(mindmapEdges);
    });
  </script>
</body>
</html>

